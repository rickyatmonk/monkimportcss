/*! 
monkimportcss
@version: 1.0.0
@date: 25-10-2013
@author: MonkDev

This plugin is to be used in lieu of the native 'importcss'. It does two thing. 
It changes the way that importcss adds span tags as it adds classes from the 'Format' select 
list. It removes this functionality and adds classes to the active element directly. 
Secondly, it adds copies of each class to explicity include common block elements in front 
(e.g. div.myclass). Users can then select the appropriate option to get the desired result 
on block elements.
*/
tinymce.PluginManager.add("monkimportcss",function(a){function b(a){return"string"==typeof a?function(b){return-1!==b.indexOf(a)}:a instanceof RegExp?function(b){return a.test(b)}:a}function c(b,c){function d(a,b){var h,i=a.href;if((b||f[i])&&(!c||c(i))){g(a.imports,function(a){d(a,!0)});try{h=a.cssRules||a.rules}catch(j){}g(h,function(a){a.styleSheet?d(a.styleSheet,!0):a.selectorText&&g(a.selectorText.split(","),function(a){e.push(tinymce.trim(a))})})}}var e=[],f={};g(a.contentCSS,function(a){f[a]=!0});try{g(b.styleSheets,function(a){d(a)})}catch(h){}return e}function d(b,c){var d,e=/^(?:([a-z0-9\-_]+))?(\.[a-z0-9_\-\.]+)$/i.exec(b);if(e){var f=e[1],g=e[2].substr(1).split(".").join(" ");return c?!e[1]&&e[2]&&(d={block:c,title:c+b,classes:g}):e[1]?(d={title:b},a.schema.getTextBlockElements()[f]?d.block=f:a.schema.getBlockElements()[f]?d.selector=f:d.inline=f):e[2]&&(d={selector:"h1,h2,h3,h4,h5,h6,td,th,li,img,a,span",title:b.substr(1),classes:g}),d&&(a.settings.importcss_merge_classes!==!1?d.classes=g:d.attributes={"class":g}),d}}function e(b,c,d,e,g){var h,i=c.call(f,b,g);if(i){var j=i.name||tinymce.DOM.uniqueId();if(d)for(var k=0;k<d.length;k++)if(!d[k].filter||d[k].filter(b)){d[k].item||(d[k].item={text:d[k].title,menu:[]}),h=d[k].item.menu;break}a.formatter.register(j,i);var l=tinymce.extend({},e.control.settings.itemDefaults,{text:i.title,format:j});h?h.push(l):e.control.add(l)}}var f=this,g=tinymce.each;a.settings.style_formats||a.on("renderFormatsMenu",function(f){var h=a.settings,i={},j=h.importcss_selector_converter||d,k=b(h.importcss_selector_filter);a.settings.importcss_append||f.control.items().remove();var l=h.importcss_groups;if(l)for(var m=0;m<l.length;m++)l[m].filter=b(l[m].filter);g(c(a.getDoc(),b(h.importcss_file_filter)),function(a){-1===a.indexOf(".mce-")&&(i[a]||k&&!k(a)||(e(a,j,l,f),e(a,j,l,f,"div"),e(a,j,l,f,"p"),i[a]=!0))}),g(l,function(a){f.control.add(a.item)}),f.control.renderNew()}),f.convertSelectorToFormat=d});